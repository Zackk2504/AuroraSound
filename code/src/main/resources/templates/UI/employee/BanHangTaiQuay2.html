<!DOCTYPE html>
<html lang="vi"  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/index}">>
<head>
    <meta charset="UTF-8">
    <title>POS - Bán Hàng Tại Quầy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f7f7f7; }
        .product-card { cursor: pointer; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 10px; background: white; transition: 0.2s; }
        .product-card:hover { background: #eef; }
        .cart-item { border-bottom: 1px solid #ddd; padding: 8px 0; }
        .cart-summary { background: white; padding: 15px; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .btn-pay { width: 100%; font-size: 1.2rem; }
        .tab-pane {
            display: block !important;
            visibility: hidden;
            height: 0;
            overflow: hidden;
        }
        .tab-pane.active {
            visibility: visible;
            height: auto;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
<div class="container-fluid mt-3">
    <div class="mt-3">
        <h5>Quét sản phẩm</h5>
<!--        <div id="qr-reader" style="width: 300px;"></div>-->
        <div id="qr-reader" hidden></div>
    </div>
    <div class="row">
        <!-- Danh sách sản phẩm -->
        <div class="col-md-8">
            <h4>Danh sách sản phẩm</h4>
            <input type="text" id="searchInput" class="form-control mb-3" placeholder="Tìm sản phẩm...">
            <h5>Hóa đơn chờ</h5>
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item" th:each="hd : ${listHoaDonCho}">
                    <a class="nav-link"
                       th:classappend="${hd.id == idHoaDon} ? 'active'"
                       th:href="@{/ban-hang-tai-quay(idhd=${hd.id})}">
                        HD #[[${hd.id}]]
                    </a>
                </li>
                <li class="nav-item">
                    <form th:action="@{/ban-hang-tai-quay/tao-moi}" method="post">
                        <button class="btn btn-sm btn-outline-success ms-2">+ Hóa đơn mới</button>
                    </form>
                </li>
            </ul>
            <div class="row" id="product-list">
                <div th:each="sp : ${ListSanPham}" class="col-md-4">
                    <form th:action="@{/ban-hang-tai-quay/addsp}" method="post">
                        <input type="hidden" name="idSanPham" th:value="${sp.id}" />
                        <input type="hidden" name="soLuong" value="1" />
                        <input type="hidden" name="idhd" th:value="${idHoaDon}" />
                        <button type="submit" class="product-card w-100 text-start border-0">
                            <!--                            <img th:src="@{${sp.hinhAnh}}" class="img-fluid mb-2" alt="Ảnh sản phẩm">-->
                            <div><strong th:text="${sp.idSanpham.tenSanPham}">Tên sản phẩm</strong></div>
                            <div class="text-muted" th:text="${sp.donGia } + '₫'">Giá</div>
                            <div class="text-muted" th:text="${sp.soLuongTon } + 'số lượng còn' ">Số lượng</div>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Giỏ hàng (Hóa đơn chi tiết) -->
        <div class="col-md-4">
            <h4>Hóa đơn hiện tại</h4>
            <div class="cart-summary">
                <div th:each="ct : ${ListHoaDonChiTiet}" class="cart-item d-flex justify-content-between align-items-center">
                    <div>
                        <div>
                            <strong th:text="${ct.idSanphamchitiet.idSanpham.tenSanPham}">Tên SP</strong>
                        </div>
                        <div class="d-flex align-items-center mt-1">
                            <!-- Nút trừ -->
                            <form th:action="@{/ban-hang-tai-quay/addsp}" method="post" class="me-2">
                                <input type="hidden" name="idSanPham" th:value="${ct.idSanphamchitiet.id}" />
                                <input type="hidden" name="idhd" th:value="${idHoaDon}" />
                                <input type="hidden" name="soLuong" value="-1" />
                                <button type="submit" class="btn btn-sm btn-outline-secondary">−</button>
                            </form>

                            <!-- Số lượng -->
                            <form th:action="@{/ban-hang-tai-quay/addsp}" method="post" class="update-form ms-2 me-2">
                                <input type="hidden" name="idSanPham" th:value="${ct.idSanphamchitiet.id}" />
                                <input type="hidden" name="idhd" th:value="${idHoaDon}" />
                                <input type="hidden" name="nhaptay" value="true" />
                                <input type="number" name="soLuong"
                                       th:value="${ct.soLuong}" min="1"
                                       class="form-control form-control-sm text-center quantity-input"
                                       style="width: 60px;" />
                            </form>

                            <!-- Nút cộng -->
                            <form th:action="@{/ban-hang-tai-quay/addsp}" method="post" class="ms-2">
                                <input type="hidden" name="idSanPham" th:value="${ct.idSanphamchitiet.id}" />
                                <input type="hidden" name="idhd" th:value="${idHoaDon}" />
                                <input type="hidden" name="soLuong" value="1" />
                                <button type="submit" class="btn btn-sm btn-outline-secondary">+</button>
                            </form>
                        </div>
                    </div>
                    <div th:text="${ct.soLuong * ct.donGia} + '₫'">0₫</div>
                </div>

                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Tổng cộng:</strong>
<!--                    <strong th:text="${#numbers.formatDecimal(ListHoaDonChiTiet.stream().mapToDouble(ct -> ct.soLuong * ct.donGia).sum(), 0, 'POINT', '.', ',')} + '₫'">0₫</strong>-->
                </div>

                <!-- Modal -->
                <div class="modal fade" id="thanhToanModal" tabindex="-1" aria-labelledby="thanhToanModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <form th:action="@{/ban-hang-tai-quay/thanhtoan/{idhd}(idhd=${idHoaDon})}" method="post">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="thanhToanModalLabel">Thông tin thanh toán</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                                </div>

                                <!-- Tabs -->
                                <ul class="nav nav-tabs" id="thanhToanTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="mua-tab" data-bs-toggle="tab" data-bs-target="#mua" type="button" role="tab">
                                            Mua hàng
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="nhan-tab" data-bs-toggle="tab" data-bs-target="#nhan" type="button" role="tab">
                                            Nhận hàng
                                        </button>
                                    </li>
                                </ul>

                                <!-- Tab content -->
                                <div class="tab-content p-3">
                                    <!-- Tab mua hàng -->
                                    <div class="tab-pane  active" id="mua" role="tabpanel" aria-labelledby="mua-tab">
                                        <div class="mb-3">

                                            <div class="col-sm-6">
                                                <label for="sdtCheck" class="form-label">SĐT khách hàng</label>
                                                <input type="text" class="form-control" id="sdtCheck" placeholder="Nhập số điện thoại...">
                                            </div>
                                            <div class="col-sm-3">
                                                <button type="button" class="btn btn-primary" onclick="timKhachHang()">Tìm</button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="tenNguoiMua" class="form-label">Tên người mua</label>
                                            <input type="text" class="form-control" id="tenNguoiMua" name="tenNguoiMua">
                                        </div>
                                        <div class="mb-3">
                                            <label for="sdtNguoiMua" class="form-label">Số điện thoại người mua</label>
                                            <input type="tel" class="form-control" id="sdtNguoiMua" name="sdtNguoiMua">
                                        </div>
                                        <div class="mt-4">
                                            <label class="form-label">Hình thức thanh toán</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="hinhThucThanhToan" id="tienMat" value="TIEN_MAT" checked>
                                                <label class="form-check-label" for="tienMat">
                                                    Tiền mặt
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="hinhThucThanhToan" id="chuyenKhoan" value="CHUYEN_KHOAN">
                                                <label class="form-check-label" for="chuyenKhoan">
                                                    Chuyển khoản
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Tab nhận hàng -->
                                    <div class="tab-pane " id="nhan" role="tabpanel" aria-labelledby="nhan-tab">
                                        <p>* Khách lấy hàng tại quầy không cần nhập</p>
                                        <div class="mb-3">
                                            <label for="tenNguoiNhan" class="form-label">Tên người nhận</label>
                                            <input type="text" class="form-control" id="tenNguoiNhan" name="tenNguoiNhan" >
                                        </div>
                                        <div class="mb-3">
                                            <label for="sdtNguoiNhan" class="form-label">Số điện thoại người nhận</label>
                                            <input type="tel" class="form-control" id="sdtNguoiNhan" name="sdtNguoiNhan" >
                                        </div>
                                        <div class="mb-3">
                                            <label for="diaChiNguoiNhan" class="form-label">Địa chỉ người nhận</label>
                                            <input type="text" class="form-control" id="diaChiNguoiNhan" name="diaChiNguoiNhan" >
                                        </div>
                                    </div>
                                </div>

                                <!-- Nút submit -->
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                                    <button type="submit" class="btn btn-primary">Xác nhận thanh toán</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>



                <button type="button" class="btn btn-success mt-3 btn-pay" data-bs-toggle="modal" data-bs-target="#thanhToanModal">
                    Thanh toán
                </button>
                <a type="button" class="btn btn-success mt-3 btn-pay" th:href="@{/ban-hang-tai-quay/delete/{idhd}(idhd=${idHoaDon})}"> Hủy hóa đơn</a>

            </div>
        </div>
    </div>
</div>
</div>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // không reload trang
                this.form.submit();     // submit form hiện tại
            }
        });

        input.addEventListener('blur', function () {
            this.form.submit(); // khi rời khỏi ô thì gửi luôn
        });
    });

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`QR Code: ${decodedText}`);

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/ban-hang-tai-quay/addsp';

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'idSanPham';
            idInput.value = decodedText;

            const qtyInput = document.createElement('input');
            qtyInput.type = 'hidden';
            qtyInput.name = 'soLuong';
            qtyInput.value = '1';

            const hdInput = document.createElement('input');
            hdInput.type = 'hidden';
            hdInput.name = 'idhd';
            hdInput.value = /*[[${idHoaDon}]]*/ 0;

            form.appendChild(idInput);
            form.appendChild(qtyInput);
            form.appendChild(hdInput);

            document.body.appendChild(form);
            form.submit();
    }

        const html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start(
        {facingMode: "environment"}, // camera sau
        {
            fps: 10,
            qrbox: 250
        },
        onScanSuccess
        ).catch(err => {
        console.error("QR Scan error", err);
    });
    document.getElementById("searchInput").addEventListener("keyup", function () {
        let keyword = this.value.toLowerCase();
        let products = document.querySelectorAll("#product-list .col-md-4");

        products.forEach(function (product) {
            let name = product.querySelector("strong").innerText.toLowerCase();
            if (name.includes(keyword)) {
                product.style.display = "block";
            } else {
                product.style.display = "none";
            }
        });
    });

    function timKhachHang() {
        const sdt = document.getElementById("sdtCheck").value.trim();
        if (!sdt) {
            alert("Vui lòng nhập số điện thoại.");
            return;
        }

        fetch(`/khach-hang/tim-theo-sdt?sdt=${encodeURIComponent(sdt)}`)
            .then(res => {
                if (!res.ok) throw new Error("Không tìm thấy khách hàng.");
                return res.json();
            })
            .then(data => {
                document.getElementById("tenNguoiMua").value = data.hoTen || '';
                document.getElementById("sdtNguoiMua").value = data.soDT || '';
                // document.getElementById("tenNguoiNhan").value = data.hoTen || '';
                // document.getElementById("sdtNguoiNhan").value = data.soDT || '';
                document.getElementById("diaChiNguoiNhan").value = data.diaChi || '';
            })
            .catch(err => {
                alert(err.message);
            });
    }

</script>
</body>
</html>
