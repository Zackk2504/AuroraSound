<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            color: #000;
            font-family: 'Segoe UI', sans-serif;
            padding-bottom: 100px;
        }

        .cart-item {
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }

        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }

        .cart-details {
            flex: 1;
        }

        .cart-actions {
            text-align: right;
        }

        .price {
            font-weight: bold;
        }

        .quantity-control {
            display: flex;
            align-items: center;
        }

        .quantity-control button {
            border: 1px solid #000;
            background: #fff;
            width: 30px;
            height: 30px;
        }

        .quantity-control input {
            width: 50px;
            text-align: center;
            border: 1px solid #ccc;
            margin: 0 5px;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            padding: 15px 30px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999; /* ƒë·∫£m b·∫£o kh√¥ng b·ªã che khu·∫•t */
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }


        .btn-checkout {
            background: #000;
            color: #fff;
            border: none;
            padding: 10px 20px;
        }

        .form-check-input:checked {
            background-color: #000;
            border-color: #000;
        }
    </style>
</head>
<body>

<div class="container mt-4">

    <h3 class="mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>

    <form id="cartForm" th:action="@{/khach-hang/thanh-toan}" method="post">

        <!-- M·ªôt s·∫£n ph·∫©m -->
        <div class="cart-item" th:each="item : ${gioHangChiTietList}">
            <input class="form-check-input me-3 item-checkbox"
                   type="checkbox"
                   name="selectedIds"
                   onsubmit="return kiemTraCheckbox();"
                   th:value="${item.id}"
                   th:data-price="${item.idSanphamchitiet.donGia}"
                   th:data-quantity="${item.soLuong}">

            <img th:if="${mapAnhDau[item.idSanphamchitiet.idSanpham.id] != null}"
                 th:src="@{${mapAnhDau[item.idSanphamchitiet.idSanpham.id].url}}"
                 class="square-img"/>

            <div class="cart-details">
                <div th:text="${item.idSanphamchitiet.idSanpham.tenSanPham}" class="fw-bold">T√™n s·∫£n ph·∫©m</div>
                <div class="text-muted small">
                    Ph√¢n lo·∫°i:
                    <span th:text="${item.idSanphamchitiet.idPhienban.tenPhienBan}"></span>,
                    <span th:text="${item.idSanphamchitiet.idMausac.tenMauSac}"></span>
                </div>
                <div class="price mt-1" th:text="${#numbers.formatDecimal(item.idSanphamchitiet.donGia, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">Gi√°</div>
                <div class="quantity-control d-flex align-items-center">
                    <button type="button"
                            class="btn btn-outline-dark btn-sm btn-minus"
                            th:data-id="${item.idSanphamchitiet.id}">‚àí</button>
                    <input type="text" class="form-control text-center mx-2 qty-input" th:value="${item.soLuong}" readonly>
                    <button type="button"
                            class="btn btn-outline-dark btn-sm btn-plus"
                            th:data-id="${item.idSanphamchitiet.id}">+</button>
                </div>
            </div>

            <div class="cart-actions">
                <a th:href="@{'/khach-hang/gio-hang/xoa?idGioHang=' + ${item.id}}"
                   onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?')"
                   class="text-danger small">X√≥a</a>            </div>
        </div>
        <!-- /M·ªôt s·∫£n ph·∫©m -->

        <div class="bottom-bar mt-4">
            <div>
                <input type="checkbox" id="chonTatCa" class="form-check-input me-2">
                <label for="chonTatCa">Ch·ªçn t·∫•t c·∫£</label>
            </div>
            <div>
                T·ªïng c·ªông: <span id="tongTien" class="fw-bold">0 ‚Ç´</span>
                <button type="submit" class="btn btn-checkout ms-3" id="btnMuaHang" disabled>Mua h√†ng</button>

            </div>
        </div>
    </form>

    <!-- Thanh d∆∞·ªõi c√πng -->


</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll(".item-checkbox");
        const chonTatCaCheckbox = document.getElementById("chonTatCa");
        const tongTienEl = document.getElementById("tongTien");
        const btnMuaHang = document.getElementById("btnMuaHang");

        function formatCurrency(amount) {
            return amount.toLocaleString("vi-VN") + " ‚Ç´";
        }

        function tinhTongTien() {
            let total = 0;
            let hasChecked = false;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    const price = parseFloat(cb.getAttribute("data-price"));
                    const qtyInput = cb.closest(".cart-item").querySelector(".qty-input");
                    const qty = parseInt(qtyInput.value);
                    total += price * qty;
                    hasChecked = true;
                }
            });
            tongTienEl.textContent = formatCurrency(total);
            btnMuaHang.disabled = !hasChecked;
        }

        chonTatCaCheckbox.addEventListener("change", function () {
            checkboxes.forEach(cb => cb.checked = chonTatCaCheckbox.checked);
            tinhTongTien();
        });

        checkboxes.forEach(cb => cb.addEventListener("change", function () {
            chonTatCaCheckbox.checked = [...checkboxes].every(c => c.checked);
            tinhTongTien();
        }));

        // TƒÉng s·ªë l∆∞·ª£ng
        document.querySelectorAll(".btn-plus").forEach(btn => {
            btn.addEventListener("click", function () {
                const card = this.closest(".cart-item");
                const input = card.querySelector(".qty-input");
                const id = this.getAttribute("data-id");
                const qty = parseInt(input.value);

                fetch(`/khach-hang/gio-hang/${id}/increase`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        input.value = qty + 1;
                        tinhTongTien();
                    } else {
                        alert("TƒÉng s·ªë l∆∞·ª£ng th·∫•t b·∫°i");
                    }
                });
            });
        });

        // Gi·∫£m s·ªë l∆∞·ª£ng
        document.querySelectorAll(".btn-minus").forEach(btn => {
            btn.addEventListener("click", function () {
                const card = this.closest(".cart-item");
                const input = card.querySelector(".qty-input");
                const id = this.getAttribute("data-id");
                const qty = parseInt(input.value);
                if (qty <= 1) return;

                fetch(`/khach-hang/gio-hang/${id}/decrease`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        input.value = qty - 1;
                        tinhTongTien();
                    } else {
                        alert("Gi·∫£m s·ªë l∆∞·ª£ng th·∫•t b·∫°i");
                    }
                });
            });
        });
    });
    function kiemTraCheckbox() {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        const coCheckboxDuocChon = Array.from(checkboxes).some(cb => cb.checked);

        if (!coCheckboxDuocChon) {
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.");
            return false; // chƒÉÃ£n submit
        }

        return true; // cho pheÃÅp submit
    }

</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
